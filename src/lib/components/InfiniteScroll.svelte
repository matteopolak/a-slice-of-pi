<script lang="ts" generics="T">
	import type { MaybePromise } from '@sveltejs/kit';
	import { tick } from 'svelte';

	import { viewport } from '$lib/use';

	export let data: T[];
	export let load: (index: number) => MaybePromise<T[]>;
	export let itemThreshold = 1;

	let done = data.length < itemThreshold && data.length > 0;
	let loading = false;
	let index = data.length === 0 ? 0 : 1;
	let shouldLoad = data.length === 0;
	let ctx = 0;

	async function next() {
		loading = true;
		
		const localCtx = ++ctx;
		const items = await load(index++);

		if (localCtx !== ctx) {
			return;
		}

		if (items.length < itemThreshold) {
			done = true;
		}

		if (items.length) {
			data.push(...items);
			data = data;
		}

		tick().then(() => {
			loading = false;
		});
	}

	function onLoadChange() {
		data = [];
		done = false;
		index = 0;

		next();
	}

	$: if (shouldLoad && !loading && !done) {
		next();
	}

	$: {
		load;
		onLoadChange();
	}
</script>

{#each data as item, i (i)}
	<slot {item} />
{/each}

{#if !done}
	{#if loading}
		<slot name="loading" />
	{/if}
{/if}

<div
	use:viewport
	on:enterviewport={() => {
		shouldLoad = true;
	}}
	on:exitviewport={() => {
		shouldLoad = false;
	}}
/>
